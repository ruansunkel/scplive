<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>UCsecure</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="dist/css/AdminLTE.css">
    <link rel="stylesheet" href="dist/css/skins/_all-skins.css">
    <link rel="stylesheet" href="plugins/pace/pace.min.css">
    <link rel="stylesheet" href="dist/css/StyleSheet.css">

    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body class="hold-transition skin-purple  sidebar-mini layout-boxed">

    <span id="notification" style="">
        <div id="notification_connectionDead" class="app-alert-item mod-error">Could not connect to SCP Server.<br>
            <span id="alertmessageinfo"></span>
            <a class="app-alert-item-button" href="#" onclick="window.location.reload()">Reload page</a>
        </div>
    </span>


    <div class="wrapper">
        <header class="main-header">
            <!-- Logo -->
            <a href="bigchat.html" class="logo hidden-xs" style="background-color: #fff;">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini"><b>UCsecure</b></span>
                <span class="logo-lg" style="background-color: #fff;"><img src="Images/GTlogo.jpg" border="0" width="80%"></span>
            </a>
            <nav class="navbar navbar-static-top">
                <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a><span class="box-title" id="conversation-title-bar" style="font-size:18px; color: #fff;padding-top: 15px;padding-left: 10px;    display: inline-block;"></span>
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <li class="dropdown user user-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <img src="https://ucsecure.pfortner.co.za/media/avatar/0/80x80" class="user-image" alt="User Image">
                                <span class="hidden-xs" id="details2_name_surname"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="user-header">
                                    <img src="https://ucsecure.pfortner.co.za/media/avatar/0/80x80" class="img-circle" alt="User Image">
                                    <p>
                                        <span id="details3_name_surname"></span>
                                        <small id="details3_email"></small>
                                    </p>
                                </li>
                                <li class="user-body">
                                <div class="form-group"><label class="control-sidebar-subheading"><input type="checkbox" data-layout="layout-boxed" class="pull-right"> Boxed Layout</label></div>

                                    <ul class="list-unstyled clearfix"><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-blue" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px; background: #367fa9"></span><span class="bg-light-blue" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222d32"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Blue</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-black" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div style="box-shadow: 0 0 2px rgba(0,0,0,0.1)" class="clearfix"><span style="display:block; width: 20%; float: left; height: 7px; background: #fefefe"></span><span style="display:block; width: 80%; float: left; height: 7px; background: #fefefe"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Black</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-purple" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-purple-active"></span><span class="bg-purple" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222d32"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Purple</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-green" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-green-active"></span><span class="bg-green" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222d32"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Green</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-red" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-red-active"></span><span class="bg-red" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222d32"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Red</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-yellow" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-yellow-active"></span><span class="bg-yellow" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #222d32"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin">Yellow</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-blue-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px; background: #367fa9"></span><span class="bg-light-blue" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Blue Light</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-black-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div style="box-shadow: 0 0 2px rgba(0,0,0,0.1)" class="clearfix"><span style="display:block; width: 20%; float: left; height: 7px; background: #fefefe"></span><span style="display:block; width: 80%; float: left; height: 7px; background: #fefefe"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Black Light</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-purple-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-purple-active"></span><span class="bg-purple" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Purple Light</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-green-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-green-active"></span><span class="bg-green" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Green Light</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-red-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-red-active"></span><span class="bg-red" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Red Light</p></li><li style="float:left; width: 33.33333%; padding: 5px;"><a href="javascript:void(0)" data-skin="skin-yellow-light" style="display: block; box-shadow: 0 0 3px rgba(0,0,0,0.4)" class="clearfix full-opacity-hover"><div><span style="display:block; width: 20%; float: left; height: 7px;" class="bg-yellow-active"></span><span class="bg-yellow" style="display:block; width: 80%; float: left; height: 7px;"></span></div><div><span style="display:block; width: 20%; float: left; height: 20px; background: #f9fafc"></span><span style="display:block; width: 80%; float: left; height: 20px; background: #f4f5f7"></span></div></a><p class="text-center no-margin" style="font-size: 12px">Yellow Light</p></li></ul>
                                </li>
                                <li class="user-footer">
                                    <div class="pull-left">
                                    </div>
                                    <div class="pull-right">
                                        <a href="#" class="btn btn-default btn-flat" id="sign-out">Sign out</a>
                                    </div>
                                </li>
                            </ul>
                        </li>
                        <li id="conv-userlist">
                            <a href="#" data-toggle="control-sidebar"><i class="fa fa-users"></i></a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
        <aside class="main-sidebar">
            <section class="sidebar">
                <a class="btn btn-newConv" id="newconvBTN">
                    <i class="fa fa-edit"></i> New Conversation
                </a>
                <form action="#" method="get" class="sidebar-form">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="Search...">
                        <span class="input-group-btn"><button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i></button></span>
                    </div>
                </form>
                
                <ul class="sidebar-menu">

                    <li class="active treeview">
                        <a href="#">
                            <i class="fa fa-users"></i>
                            <span>CONVERSATIONS</span>
                            <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                        </a>
                        <ul class="treeview-menu" id="conversation-container" style="overflow-y: overlay;-webkit-overflow-scrolling: touch;">
                        </ul>
                    </li>
                    <li class="treeview">
                        <a href="#">
                            <i class="fa fa-user"></i>
                            <span>DIRECT CHATS</span>
                            <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                        </a>
                        <ul class="treeview-menu" id="direct-chats-container" style="overflow-y: overlay;-webkit-overflow-scrolling: touch;">
                        </ul>
                    </li>
                    <li >
                        <a href="#">
                            <i class="fa fa-file-text-o"></i>
                            <span>MY FILES</span>
                            <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                        </a>
                    </li>
                </ul>
            	<div class="powered-by sidebar-menu" style="background-color: #fff; text-align: center;    bottom: 0px;position: absolute; width: 100%;">Secured and powered by <br><img src="Images/pfortner.png"></div>    
            </section>
            
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Main content -->
            <section class="content">
                <div class="row">
                    <div class="col-md-12" style="padding-right: 0px; padding-left: 0px;" >
                        <div class="row" style="display: none" id="mainconCreate">
                            <div class="col-md-3 hidden-xs"></div>
                            <div class="col-md-6">
                        <div class="box box-new-conv box-primary ">

                            <div class="box-header with-border " >
                              <input type="email" class="form-control" id="frmConvSubject" placeholder="CONVERSATION SUBJECT">
                            </div>
                            <!-- /.box-header -->
                            <!-- form start -->

                              <div class="box-body" style="padding-top: 35px;">

                                  <div class="row">
                                    <div class="col-md-12"><label>Find a user / group:&nbsp;</label>
                                        <input type="email" class="frmSearchUser" id="frmSearchUser" placeholder="search" style="max-width: 500px; width: 100%;">
                                    </div>
                                    
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                        <div id="convNewUsers" style="padding-top: 30px;padding-bottom: 30px;" class="convNewUsersCL"></div> 
                                    </div>
                                  </div>

                              </div>
                            <div class="" id="message-loading-overlay-new">
                              <i class="" id="message-loading-spinner-new"></i>
                            </div>
                              <!-- /.box-body -->

                                <button type="button" id="create-Conv" class="btn btn-primary btn-block btn-flat" style="border-radius: 0.5em;">Create</button>


                          </div>
                            </div>
                            <div class="col-md-3 hidden-xs"></div>
                        </div>
                        <!-- DIRECT CHAT -->
                        <div class="box box-warning direct-chat direct-chat-warning" style="border-top-color:#bbd9e9; border-top-width: 0px; " id="mainchatBox">
                            <div class="box-body">
                                <!-- Conversations are loaded here -->
                                <div class="direct-chat-messages" id="message-container">
                                </div>

                            </div>
                            <div class="overlay" id="message-loading-overlay">
                              <i class="fa fa-refresh fa-spin" id="message-loading-spinner"></i>
                            </div>
                            <!-- /.box-body -->
                            <div class="box-footer">
                                <!--<form action="#" method="post">-->
                                <div class="input-group" style="    height: 30px;">
                                    <label for="file-upload" class="custom-file-upload">
                                        <i class="fa fa-upload"></i> Upload File
                                    </label>
                                    <input id="file-upload" type="file"/>
                                    <input id="text-input" type="text" name="message" placeholder="Type Message ..." class="form-control" autocomplete="off">
                                    <span id="send-button" class="input-group-btn" style="    vertical-align: top;"><button type="button" class="btn btn-flat">Send</button></span>
                                </div>
                                <!--</form>-->
                            </div>
                            <!-- /.box-footer-->
                        </div>
                        <!--/.direct-chat -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->

        <!-- Control Sidebar -->
        <aside class="control-sidebar control-sidebar-dark">

            <!-- Tab panes -->
            <div class="tab-content">

                <div class="tab-pane active" id="control-sidebar-settings-tab">
                    <h3 class="control-sidebar-heading">Conversation Users</h3>
                    <ul class="control-sidebar-menu" id="sidebar-users"  style="overflow: auto;">

                    </ul>

                </div>
                <!-- /.tab-pane -->
            </div>
        </aside>

        <div class="control-sidebar-bg"></div>
    </div>
    <!-- ./wrapper -->
    <div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" data-dismiss="modal">
            <div class="modal-content"  >              
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <img src="" id="idimagepreview"  class="imagepreview img-responsive" >
                </div>         
            </div>
        </div>
    </div>

    <script src="plugins/jQuery/jquery-2.2.3.min.js"></script>

    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="dist/js/app.js"></script>
    <script src="dist/js/pace.js"></script>
    <script type="text/javascript" src="plugins/jquery.autocomplete.js"></script>
    <!--<script src="plugins/slimScroll/jquery.slimscroll.min.js"></script>-->
    <!--<script src="dist/js/demo.js"></script>-->

    <!-- ########## SCP Specific Javascript ########## -->
    <!-- Resizing -->
    <script type="text/javascript">
        function resize() {

            
            // Message Window
            document.getElementsByClassName("direct-chat-messages")[0].style.height = (
                window.innerHeight -
                document.getElementsByClassName("main-header")[0].clientHeight -
                document.getElementsByClassName("box-footer")[0].clientHeight -10
            ) + "px";

            var element = document.getElementById("message-container");
            element.scrollTop = element.scrollHeight - element.clientHeight;

            // Create message window
            document.getElementById("mainconCreate").style.height = (
                window.innerHeight -
                document.getElementsByClassName("main-header")[0].clientHeight-5
            ) + "px";

            //Left Side bar dynamic height for scroll
            document.getElementsByClassName("treeview-menu")[0].style.height = (
                window.innerHeight -
                document.getElementsByClassName("main-header")[0].clientHeight -
                document.getElementsByClassName("btn-newConv")[0].clientHeight -
                document.getElementsByClassName("powered-by")[0].clientHeight -
                document.getElementsByClassName("sidebar-form")[0].clientHeight - 175

            ) + "px";

            //Right Side bar dynamic height for scroll
            document.getElementsByClassName("control-sidebar-menu")[0].style.height = (
                window.innerHeight -
                document.getElementsByClassName("main-header")[0].clientHeight - 100

            ) + "px";


            
        }

        window.addEventListener("resize", function () {
            setTimeout(function () {
                resize();
            }, 200);
        }, false);

        resize();

        document.getElementsByClassName("box")[0].style.marginBottom = 0;
    </script>

    <!-- SCP API Calls -->
    <script type="text/javascript" name="SCP API Calls">
        var DOMAIN = "ucsecure.pfortner.co.za";

        // Globals
        var MSCT = 0;
        var TIMESTAMP = 0;
        var pollTimer = 0;
        var conversationPollTimer = 0;
        var conversationId = 0;
		var lastMessage = "";

        function scpAPICall(api, callback, data = null, Synchro=true) {
            

            var xmlHttp = new XMLHttpRequest();

            try{
                xmlHttp.open("post", "https://" + DOMAIN + "/request/api/" + api, Synchro);
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8 ");
                xmlHttp.withCredentials = true;
                xmlHttp.onreadystatechange = function(e) {
                    if (xmlHttp.readyState === 4) {
                        if (xmlHttp.status === 200) {
                            clearTimeout(xmlHttpTimeout); 
                            callback(xmlHttp.responseText);
                        }
                    }
                };

                xmlHttp.send(data);

                var xmlHttpTimeout=setTimeout(ajaxTimeout,20000);
                function ajaxTimeout(){
                   xmlHttp.abort();
                   if (Synchro==true){
                       var notificationalert = document.getElementById("notification");
                       notificationalert.setAttribute("style", "display: block;");
                       // document.getElementById("alertmessageinfo").innerHTML="Timeout: "+api;
                   }
                }
             } catch (e) {
                         var notificationalert = document.getElementById("notification");
                           notificationalert.setAttribute("style", "display: block;");
                         //  document.getElementById("alertmessageinfo").innerHTML="Error: "+api;
                        console.error(e);
                }

        }

        function populateDetails() {
            scpAPICall("myaccount/details", function(response) {
                var details = JSON.parse(response);
                //document.getElementById("details_name_surname").innerHTML = details.name_first + " " + details.name_last;
                document.getElementById("details2_name_surname").innerHTML = details.name_first + " " + details.name_last;
                document.getElementById("details3_name_surname").innerHTML = details.name_first + " " + details.name_last;
                document.getElementById("details3_email").innerHTML = details.email_primary;
            });
        }


        // Conversation Functions
        function renderConversations(conversations) {
            //console.log("Render Conversation");
            // Loop through converations and create html elements and events
            conversations.reverse().forEach(function(element) {
                // Loop through current conversations and remove existing conversations
                for (var i = 0; i < document.getElementById("conversation-container").children.length; i++) {
                    if (parseInt(document.getElementById("conversation-container").children[i].getAttribute("conversation-id")) === element.id) {
                        document.getElementById("conversation-container").children[i].remove();
                    }
                }

                // Create html element
                var li = document.createElement("li");
                li.setAttribute("class", "conversation-list-li");
                li.setAttribute("conversation-id", element.id);
                document.getElementById("conversation-container").insertBefore(li, document.getElementById("conversation-container").firstChild);
                var href = document.createElement("a");
                href.setAttribute("href", "#");
                li.appendChild(href);

                var convImg;
                var convSubject;
                console.log("Flags: " +element.flags );
                if ((element.flags & 16) === 16) {
                    convImg = "https://ucsecure.pfortner.co.za/media/avatar/" + Object.keys(element.users) + "/48x48";
                    convSubject = element.users[Object.keys(element.users)];
                } else {
                    convImg = "https://ucsecure.pfortner.co.za/assets/defaults/group.png";
                    convSubject = element.subject;
                }
                //*************************************////*************************************//
                if ((element.flags & 1) === 1) {
                    console.log("Change icon" );
                    change_favicon('faviconalert.ico');
                    li.classList.add("unread");
                }

				// Always show unread marker when conversation has been updated
				if (MSCT > 0) {
					if (element.value !== lastMessage) {
						change_favicon('faviconalert.ico');
						li.classList.add("unread");
					}
				}

                var convDiv = document.createElement("div");
                href.appendChild(convDiv);

                var convDivImg = document.createElement("img");
                convDivImg.setAttribute("style", "height:48px;width:48px;vertical-align: middle;display: inline-block;margin-right: 10px;");
                convDivImg.setAttribute("class", "direct-chat-img");
                convDivImg.setAttribute("src", convImg);
                convDivImg.setAttribute("border", "0");
                convDiv.appendChild(convDivImg);

                var convDivTxt = document.createElement("div");
                convDivTxt.setAttribute("style", "vertical-align: middle;display: inline-block; font-size: medium;");
                convDiv.appendChild(convDivTxt);

                    
                convDivTxt.innerHTML=convSubject+"<span class='conversation-message'>"+element.value.substring(0,63)+"</span>"


                // Set click listener
                href.onclick = function() {
					// If current active conversation had unread marker, remove it
					Array.prototype.forEach.call(document.getElementsByClassName("conversation-list-active"), function(element) {
						element.classList.remove("unread");
					});

                    $("#conversation-container>li.conversation-list-active").removeClass("conversation-list-active");

                    document.getElementById("message-container").innerHTML = "";
                    li.setAttribute("class", "conversation-list-li conversation-list-active");
                    //*************************************////*************************************//
                    //*************************************////*************************************//
                    li.classList.remove("unread");
                    console.log("Change back");
                    change_favicon('favicon.ico');
                    populateMessages(element);
                    conversationId = element.id;
                    if (window.outerWidth <767){
                        $('body').removeClass("sidebar-open");
                       // $('body').addClass("sidebar-collapse");
                    }
                    if (document.getElementById("mainconCreate").style.display == ""){
                        document.getElementById("mainchatBox").style.display = ""
                        document.getElementById("mainconCreate").style.display = "none"
                        document.getElementById("conv-userlist").style.display = ""
                    }
                }


            }, this);

            // Set selected conversation
            for (var i = 0; i < document.getElementById("conversation-container").children.length; i++) {
                if (parseInt(document.getElementById("conversation-container").children[i].getAttribute("conversation-id")) === conversationId) {
                    document.getElementById("conversation-container").children[i].classList.add("conversation-list-active");
                    
                    //setAttribute("class", "conversation-list-li conversation-list-active");
                }
            }
        }

        function populateConversations(foceconversationid=null) {
            //console.log("Populate Conversation");
            scpAPICall("conversations/list", function(response) {
                conversations = JSON.parse(response).items;

                // Fetch messages of first conversation
                if (conversations) {
                    // Update timestamp
                    conversations.forEach(function(conversation) {
                        if (conversation.created > TIMESTAMP) {
                            TIMESTAMP = conversation.created + 1;
                        }
                    });
                    //console.log(conversations);
                   // if (foceconversationid==null){
                        populateMessages(conversations[0]);
                        conversationId = conversations[0].id;
                   // }else{
                    //    var index = conversations.map(function (myid) { return myid.id; }).indexOf(foceconversationid);

                    //    console.log(index);
                    //    populateMessages(conversations[index]);
                    //    conversationId = conversations[index].id; 
                   // }
                    renderConversations(conversations);
                }

                // Start Conversation Polling
                conversationPollTimer = setInterval(function() {
                    //console.log("populateConversations - Timer - renderConversations");
                    scpAPICall("conversations/list", function(response) {
                        conversations = JSON.parse(response).items;

                        if (conversations) {
                            // Update timestamp
                            conversations.forEach(function(conversation) {
                                if (conversation.created > TIMESTAMP) {
                                    TIMESTAMP = conversation.created + 1;
                                }
                            });
                            console.log("new messages found");
                            renderConversations(conversations);
                        }
                    }, "ps=10&pg=1&op=16&ts=" + TIMESTAMP);
                }, 3000);

                document.getElementById("conversation-container").children[0].setAttribute("class", "conversation-list-li conversation-list-active");
            }, "ps=10&pg=1&op=16");
        }

        // Message Functions
        function renderMessages(conversation, messagesResponse) {
            //console.log("write message");
            // set overlay
            var messageovelay = document.getElementById("message-loading-overlay");
            messageovelay.setAttribute("class", "overlay");
            var messagespinner = document.getElementById("message-loading-spinner");
            messagespinner.setAttribute("class", "fa fa-refresh fa-spin");

            // Set Conversation Title
            if ((conversation.flags & 16) === 16) {
                document.getElementById("conversation-title-bar").innerHTML = "Direct Chat";
            } else {
                document.getElementById("conversation-title-bar").innerHTML = "<strong>"+conversation.subject+"</strong>";
            }

            // Set Participants - Right Sidebar
            document.getElementById("sidebar-users").innerHTML="";
            scpAPICall("conversation/recipients", function(response) {
                response = JSON.parse(response);
                if (!response.users) {
                    return;
                }
                response.users.forEach(function(userdet) {

                    usersideContainer = document.createElement("li");
                    usersideContainer.setAttribute("style", "padding-left: 15px;");
                    document.getElementById("sidebar-users").appendChild(usersideContainer);

                    usersideLink = document.createElement("a");
                    usersideLink.setAttribute("href", "javascript:void(0)");
                    usersideContainer.appendChild(usersideLink);

                    usersideAvatar = document.createElement("img");
                    usersideAvatar.setAttribute("class", "direct-chat-img");
                    usersideAvatar.setAttribute("src", "https://ucsecure.pfortner.co.za/media/avatar/" + userdet.id + "/40x40");
                    usersideLink.appendChild(usersideAvatar);

                    usersideDiv = document.createElement("div");
                    usersideDiv.setAttribute("class", "menu-info");
                    usersideLink.appendChild(usersideDiv);

                    usersideName = document.createElement("h4");
                    usersideName.setAttribute("class", "control-sidebar-subheading");
                    usersideDiv.appendChild(usersideName);

                    usersideP = document.createElement("p");
                    usersideDiv.appendChild(usersideP);

                    usersideName.innerHTML = userdet.name;
                    if ((conversation.flags & 16) === 16) {
                        document.getElementById("conversation-title-bar").innerHTML += " - <strong>" + userdet.name + "</strong>";
                    }
                    });


               // document.getElementById("participants-list").innerHTML = response.users.map(function(element) {
                //    return element.name;
               // }).join(", ");
                resize();
            }, "id=" + conversation.id, true);

			// Create Message List
			var currentMessageList = Array.prototype.map.call(document.getElementById("message-container").children, function(element) {
				return element.getAttribute("message-id");
			});

            var repeatuserid =0;
            var MessageDateCheck="";
            messagesResponse.items.reverse().forEach(function(message) {
				if(currentMessageList.indexOf(String(message.id)) > -1) {
					return;
				}

                var user = messagesResponse.users.find(function(user) {
                    return user.id === message.user_id;
                });


                if (MessageDateCheck != strftime('%d %B %Y', new Date(message.created * 1000)) ){
                    //Check date change and show date break line
                     chatDateline = document.createElement("div");
                    chatDateline.setAttribute("class", "strike");
                    document.getElementById("message-container").appendChild(chatDateline);

                    chatDateline.innerHTML="<span>" + strftime('%d %B %Y', new Date(message.created * 1000))  + "</span>"
                    MessageDateCheck=strftime('%d %B %Y', new Date(message.created * 1000))
                }

                var pushclass="";
                var timeposition="";
                if (user.flags ==1){
                    timeposition="direct-chat-timestamp-left";
                    if (message.user_id != repeatuserid) {
                        pushclass=" right"
                        
                    }else{
                        pushclass=" rightrepeat"                    
                    }
                }else{
                    timeposition="direct-chat-timestamp";
                    if (message.user_id != repeatuserid) {
                        pushclass="" 
                    }else{
                        pushclass=" leftrepeat"                    
                    }
                }
                
                chatContainer = document.createElement("div");
                chatContainer.setAttribute("class", "direct-chat-msg" + pushclass);
				chatContainer.setAttribute("message-id", message.id);
                document.getElementById("message-container").appendChild(chatContainer);

                if (message.type != "addu" && message.type != "addg") {
                    chatInfo = document.createElement("div");
                    chatInfo.setAttribute("class", "direct-chat-info clearfix");
                    chatContainer.appendChild(chatInfo);

                    var options = {
                        weekday: "long",
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit"
                    };

                    if (message.user_id != repeatuserid) {
                        chatName = document.createElement("span");
                        chatName.setAttribute("class", "direct-chat-name " + (((user.flags & 1) === 1) ? "pull-right" : ""));
                        chatName.innerHTML = user.name;
                        chatInfo.appendChild(chatName);
                        //new Date(message.created * 1000).toLocaleDateString("en-ZA", options)
                        chatAvatar = document.createElement("img");
                        chatAvatar.setAttribute("class", "direct-chat-img direct-chat-img-message");
                        chatAvatar.setAttribute("src", "https://ucsecure.pfortner.co.za/media/avatar/" + message.user_id + "/30x30");
                        chatAvatar.innerHTML = message.created;
                        chatContainer.appendChild(chatAvatar);

                        repeatuserid=message.user_id;
                    }
                }

                chatText = document.createElement("div");
                chatText.setAttribute("class", "direct-chat-text");
                chatText.setAttribute("style", " word-break: break-word;");
                if (message.type === "text") {
                    chatText.innerHTML = message.text.linkify().replace(/\n/g, "<br />");
                }

                if (message.type === "file") {
                    var image = document.createElement("img");

                    image.setAttribute("id", "imgid-"+message.id);
                    image.setAttribute("style", "cursor: pointer;");
                    image.src = message.text.split("|")[1];
                    image.src = "https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id=" + conversation.id + "&mi=" + message.id + "&op=1";

                    chatText.appendChild(image);
                    chatText.style.minHeight = "120px";
                    chatText.innerHTML += "<br />" + message.text.split("|")[1];
                    chatText.innerHTML += "<br />" + message.text.split("|")[0];
                    var filetype = message.text.split("|")[1].split('.').pop();
                    switch( filetype.toLowerCase() ) {
                        case "jpg": case "png": case "jpeg":
							chatText.style.minHeight = "210px";
                            //Modal Image
                            chatText.onclick = function() {
                                console.log("CLick image");
                                mymodalimg = document.getElementById("idimagepreview");
                                mymodalimg.setAttribute("src","https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id=" + conversation.id + "&mi=" + message.id);
                                mymodalimgdescrip = document.getElementById("imagedescrip");
                                mymodalimg.setAttribute("style", "max-height:"+(window.innerHeight-80)+"px;");
			                    $('#imagemodal').modal('show'); 
                            };
                          break;
                        case "mov": case "mp4":
							chatText.style.minHeight = "210px";
                            chatText.innerHTML = `
								<video  controls style="width: 250px" >
									<source src="` + "https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id="+conversation.id+"&mi="+message.id + `" type="video/mp4">
								</video>
							`;
                          break;
                        case "mp3": case "wav": 
                            chatText.innerHTML = `
								<audio controls style="width: 250px">
									<source src="` + "https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id="+conversation.id+"&mi="+message.id + `" >
								</audio>
							`;
                          break;
                        default:
                            //Download file
                            chatText.onclick = function() {
                                window.open("https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id="+conversation.id+"&mi="+message.id, "_blank");
                                //window.location.href = "https://ucsecure.pfortner.co.za/request/api/conversation/attachment?id="+conversation.id+"&mi="+message.id;
                            }
                      } 
                }
                

                if (message.type === "audr") {
                    if (message.text.split("|")[1]) {
                        chatText.innerHTML += "<img src='https://ucsecure.pfortner.co.za/assets/icons/phone.png' style='width: 20px'/> " + user.name + " established a call with " + message.text.split("|")[2];

                        chatText.innerHTML += `<br/><br />
								<audio controls style="width: 250px">
									<source src="` + "https://ucsecure.pfortner.co.za/media/recording/" + message.text.split("|")[1] + `" type="audio/mp3">
								</audio>
							`;
                    } else {
                        chatText.innerHTML += "<img src='https://ucsecure.pfortner.co.za/assets/icons/phonerr.png' style='width: 20px'/> " + user.name + " attempted a call with " + message.text.split("|")[2];
                    }
                }

                if (message.type === "addu") {
                    chatText.innerHTML = "User <b>" + message.text.split("|")[1] + "</b> was added to the conversation";
                    chatText.setAttribute("class", "direct-chat-statusmessage");
                }
                if (message.type === "delu") {
                    chatText.innerHTML = "User <b>" + message.text.split("|")[1] + "</b> was removed from the conversation";
                    chatText.setAttribute("class", "direct-chat-statusmessage");
                }
                if (message.type === "addg") {
                    chatText.innerHTML = "Group <b>" + message.text.split("|")[1] + "</b> was added to the conversation";
                    chatText.setAttribute("class", "direct-chat-statusmessage");
                }
                if (message.type === "delg") {
                    chatText.innerHTML = "Group <b>" + message.text.split("|")[1] + "</b> was removed from the conversation";
                    chatText.setAttribute("class", "direct-chat-statusmessage");
                }

                chatContainer.appendChild(chatText);
				var date = document.createElement("span");
				date.classList.add("direct-chat-timestamp");
				date.classList.add(timeposition);
				date.innerHTML = strftime('%H:%M', new Date(message.created * 1000));
				chatContainer.appendChild(date);
            });

            // Clear overlay
            messageovelay.setAttribute("class", "");
            messagespinner.setAttribute("class", "");

            var element = document.getElementById("message-container");
			element.scrollTop = Number.MAX_SAFE_INTEGER;
        }

        function getAndRenderMessages(conversation) {
            
            scpAPICall("conversation/messages", function(response) {
                // Parse Response
                response = JSON.parse(response);
                var notificationalertClear = document.getElementById("notification");
                notificationalertClear.setAttribute("style", "");
                if (response.items) {
                    // Update MSCT
                    MSCT = response.items[0].id;
                    //console.log("getAndRenderMessages");
                    // Render Messages
                    renderMessages(conversation, response);
                }
            }, "id=" + conversation.id + "&mi=" + MSCT);
        }

        function populateMessages(conversation) {
            //console.log("populateMessages");
            clearInterval(pollTimer);
            MSCT = 0;

            //getAndRenderMessages(conversation);

            pollTimer = setInterval(function() {
                //console.log("populateMessages - Timer - getAndRenderMessages");
                getAndRenderMessages(conversation);
            }, 2000);
        }

        function initializeClickHandlers() {
            document.getElementById("send-button").onclick = function() {
                if (document.getElementById("text-input").value == "") {
                    return;
                }

                scpAPICall("conversation/post", function() {}, "id=" + conversationId + "&text=" + document.getElementById("text-input").value);
				lastMessage = document.getElementById("text-input").value;
                document.getElementById("text-input").value = "";

				// If current active conversation had unread marker, remove it
				Array.prototype.forEach.call(document.getElementsByClassName("conversation-list-active"), function(element) {
					element.classList.remove("unread");
				});
				change_favicon('favicon.ico');
            }

            document.getElementById("text-input").onkeyup = function(evt) {
                if (evt.keyCode == 13) {
                    scpAPICall("conversation/post", function() {}, "id=" + conversationId + "&text=" + document.getElementById("text-input").value);
					lastMessage = document.getElementById("text-input").value;
                    document.getElementById("text-input").value = "";

					// If current active conversation had unread marker, remove it
					Array.prototype.forEach.call(document.getElementsByClassName("conversation-list-active"), function(element) {
						element.classList.remove("unread");
					});
					change_favicon('favicon.ico');
                }
            }
        }
        
        //Format dates and times
        function strftime(sFormat, date) {
          if (!(date instanceof Date)) date = new Date();
          var nDay = date.getDay(),
            nDate = date.getDate(),
            nMonth = date.getMonth(),
            nYear = date.getFullYear(),
            nHour = date.getHours(),
            aDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
            aMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            aDayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334],
            isLeapYear = function() {
              return (nYear%4===0 && nYear%100!==0) || nYear%400===0;
            },
            getThursday = function() {
              var target = new Date(date);
              target.setDate(nDate - ((nDay+6)%7) + 3);
              return target;
            },
            zeroPad = function(nNum, nPad) {
              return ('' + (Math.pow(10, nPad) + nNum)).slice(1);
            };
          return sFormat.replace(/%[a-z]/gi, function(sMatch) {
            return {
              '%a': aDays[nDay].slice(0,3),
              '%A': aDays[nDay],
              '%b': aMonths[nMonth].slice(0,3),
              '%B': aMonths[nMonth],
              '%c': date.toUTCString(),
              '%C': Math.floor(nYear/100),
              '%d': zeroPad(nDate, 2),
              '%e': nDate,
              '%F': date.toISOString().slice(0,10),
              '%G': getThursday().getFullYear(),
              '%g': ('' + getThursday().getFullYear()).slice(2),
              '%H': zeroPad(nHour, 2),
              '%I': zeroPad((nHour+11)%12 + 1, 2),
              '%j': zeroPad(aDayCount[nMonth] + nDate + ((nMonth>1 && isLeapYear()) ? 1 : 0), 3),
              '%k': '' + nHour,
              '%l': (nHour+11)%12 + 1,
              '%m': zeroPad(nMonth + 1, 2),
              '%M': zeroPad(date.getMinutes(), 2),
              '%p': (nHour<12) ? 'AM' : 'PM',
              '%P': (nHour<12) ? 'am' : 'pm',
              '%s': Math.round(date.getTime()/1000),
              '%S': zeroPad(date.getSeconds(), 2),
              '%u': nDay || 7,
              '%V': (function() {
                      var target = getThursday(),
                        n1stThu = target.valueOf();
                      target.setMonth(0, 1);
                      var nJan1 = target.getDay();
                      if (nJan1!==4) target.setMonth(0, 1 + ((4-nJan1)+7)%7);
                      return zeroPad(1 + Math.ceil((n1stThu-target)/604800000), 2);
                    })(),
              '%w': '' + nDay,
              '%x': date.toLocaleDateString(),
              '%X': date.toLocaleTimeString(),
              '%y': ('' + nYear).slice(2),
              '%Y': nYear,
              '%z': date.toTimeString().replace(/.+GMT([+-]\d+).+/, '$1'),
              '%Z': date.toTimeString().replace(/.+\((.+?)\)$/, '$1')
            }[sMatch] || sMatch;
          });
        }

        //Check session still active and then load the page sections
        scpAPICall("session/access", function(response) {
            if (response > 0) {
                populateDetails();
                populateConversations();
                initializeClickHandlers();
            } else {
                window.location = "/index.html";
            }
        });

        // Logout       
            document.getElementById("sign-out").onclick = function () {
                scpAPICall("session/logout", function(response) {});
                window.location = "/index.html";
            };

        //Show Create conversation
            document.getElementById("newconvBTN").onclick = function () {

                for (var i = 0; i < document.getElementById("conversation-container").children.length; i++) {
                    document.getElementById("conversation-container").children[i].setAttribute("class", "conversation-list-li");
                }
                document.getElementById("conversation-title-bar").innerHTML="New Conversation";
                document.getElementById("message-container").innerHTML = "";

                document.getElementById("mainchatBox").style.display = "none"
                document.getElementById("mainconCreate").style.display = ""
                document.getElementById("conv-userlist").style.display = "none"

                if (window.outerWidth <767){
                    $('body').removeClass("sidebar-open");
                   // $('body').addClass("sidebar-collapse");
                }
                document.getElementById("sidebar-users").innerHTML="";
            };

        //Autocomplete search users for new conversation
        //https://www.devbridge.com/sourcery/components/jquery-autocomplete/
            $('#frmSearchUser').autocomplete({
                minChars:2,
                preserveInput: true,
                lookup: function (query, done) {
                    var result = {};
                    var suggestions = [];
                    result.suggestions = suggestions;


                    scpAPICall("users/list", function(response) {
                        searchresults = JSON.parse(response).items;
                        if (response !="[]") {
                            searchresults.forEach(function (element) {
                                result.suggestions.push({
                                    "value": element.name,
                                    "data":  { category: 'Users' },
                                    "myid": element.id
                                });
                            });
                        }

                    },"qs=" + query + "&op=33",false);

                    scpAPICall("users/list", function(response) {
                        searchresults = JSON.parse(response).items;
                        if (response !="[]") {
                            searchresults.forEach(function (element) {
                                result.suggestions.push({
                                    "value": element.name,
                                    "data":  { category: 'Clients' },
                                    "myid": element.id
                                });
                            });
                        }

                    },"qs=" + query + "&op=34",false);

                    scpAPICall("groups/list", function(response) {
                        searchGresults = JSON.parse(response).items;
                        if (response !="[]") {
                            searchGresults.forEach(function (element) {
                                result.suggestions.push({
                                    "value": element.name,
                                    "data":  { category: 'Groups' },
                                    "myid": element.id
                                });
                            });
                        }

                    },"qs=" + query + "&op=0",false);

                    //console.log(result);
                    done(result);
                },
                groupBy: 'category',
                onSelect: function (suggestion) {
                    $('#convNewUsers').append('<div userid="'+suggestion.myid+'" class="list-'+suggestion.data.category+'" usertype="'+suggestion.data.category+'" >' + suggestion.value +' ('+suggestion.data.category+')' + ' &nbsp;&nbsp;&nbsp;<a href="#" class="item"><i class="fa fa-trash-o"></i></a></div>');
                }
            });
        
         //Remove user from list
        $(document).on('click','.item',function(){
            $(this).parent().remove();
        });


        //Send create conversation API call
        document.getElementById("create-Conv").onclick = function () {

           // if (document.getElementById("frmConvSubject").value != "" ) {
                var messageovelay = document.getElementById("message-loading-overlay-new");
                messageovelay.setAttribute("class", "overlay");
                var messagespinner = document.getElementById("message-loading-spinner-new");
                messagespinner.setAttribute("class", "fa fa-refresh fa-spin");

                var querystring="subject="+document.getElementById("frmConvSubject").value;


                $('.list-Users').each(function(index){
                    querystring+="&user["+$(this).attr('userid')+"]="+$(this).attr('userid')
                });
                $('.list-Groups').each(function(index){
                    querystring+="&group["+$(this).attr('userid')+"]="+$(this).attr('userid')
                });
                $('.list-Clients').each(function(index){
                    querystring+="&user["+$(this).attr('userid')+"]="+$(this).attr('userid')
                });

                querystring+="&flags:0"
                //console.log(querystring);

                scpAPICall("conversation/create", function(response) {
                        //console.log(response);
                        if (response!=""){
                            document.getElementById("conversation-container").innerHTML="";
                            populateConversations(response);
                            document.getElementById("mainchatBox").style.display = "";
                            document.getElementById("mainconCreate").style.display = "none";
                            document.getElementById("conv-userlist").style.display = ""
                        }

                    },encodeURI(querystring));
                // Clear overlay
                messageovelay.setAttribute("class", "");
                messagespinner.setAttribute("class", "");
          //  } else {
          //      alert("Please enter a conversation subject");
          //  }
        };

        //Make URLs and emails linkable
        if(!String.linkify) {
            String.prototype.linkify = function() {

                // http://, https://, ftp://

                var urlPattern = /\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;

                // www. sans http:// or https://
                var pseudoUrlPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;

                // Email addresses
                var emailAddressPattern = /[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;

                return this
                    .replace(urlPattern, '<a target="_blank" href="$&">$&</a>')
                    .replace(pseudoUrlPattern, '$1<a target="_blank" href="http://$2">$2</a>')
                    .replace(emailAddressPattern, '<a href="mailto:$&">$&</a>');
            };
        }

        //Change the favicon for notifications
        function change_favicon(img) {
            var favicon = document.querySelector('link[rel="shortcut icon"]');
    
            if (!favicon) {
                favicon = document.createElement('link');
                favicon.setAttribute('rel', 'shortcut icon');
                var head = document.querySelector('head');
                head.appendChild(favicon);
            }
    
    
            favicon.setAttribute('type', 'image/ico');
            favicon.setAttribute('href', img);
        }


    (function ($, AdminLTE) {

          var my_skins = [
            "skin-blue",
            "skin-black",
            "skin-red",
            "skin-yellow",
            "skin-purple",
            "skin-green",
            "skin-blue-light",
            "skin-black-light",
            "skin-red-light",
            "skin-yellow-light",
            "skin-purple-light",
            "skin-green-light"
          ];

        var tmp = get('skin');
        if (tmp && $.inArray(tmp, my_skins))
          change_skin(tmp);

        //Add the change skin listener
        $("[data-skin]").on('click', function (e) {
          if($(this).hasClass('knob'))
            return;
          e.preventDefault();
          change_skin($(this).data('skin'));
        });

          function change_skin(cls) {
            $.each(my_skins, function (i) {
              $("body").removeClass(my_skins[i]);
            });

            $("body").addClass(cls);
            store('skin', cls);
            return false;
          }
        function store(name, val) {
            if (typeof (Storage) !== "undefined") {
              localStorage.setItem(name, val);
            } else {
              window.alert('Please use a modern browser to properly view this template!');
            }
          }

        function get(name) {
            if (typeof (Storage) !== "undefined") {
              return localStorage.getItem(name);
            } else {
              window.alert('Please use a modern browser to properly view this template!');
            }
          }

        function change_layout(cls) {
            $("body").toggleClass(cls);
            AdminLTE.layout.fixSidebar();
            //Fix the problem with right sidebar and layout boxed
            if (cls == "layout-boxed")
              AdminLTE.controlSidebar._fix($(".control-sidebar-bg"));
            if ($('body').hasClass('fixed') && cls == 'fixed') {
              AdminLTE.pushMenu.expandOnHover();
              AdminLTE.layout.activate();
            }
            AdminLTE.controlSidebar._fix($(".control-sidebar-bg"));
            AdminLTE.controlSidebar._fix($(".control-sidebar"));
          }

        $("[data-layout]").on('click', function () {
            change_layout($(this).data('layout'));
        });
    if ($('body').hasClass('layout-boxed')) {
      $("[data-layout='layout-boxed']").attr('checked', 'checked');
    }
    })(jQuery, $.AdminLTE);

    </script>
</body>

</html>